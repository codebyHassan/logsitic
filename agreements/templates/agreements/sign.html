{% extends "agreements/base.html" %}
{% block title %}Sign Agreement{% endblock %}
{% block content %}

<!-- Load Google Font for signature style -->
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@600&family=Parisienne&display=swap" rel="stylesheet">

<!-- Animated Stepper -->
<div class="stepper-wrapper">
  <div class="stepper-item completed" data-step="1">
    <div class="step-counter">
      <i class="check-icon">‚úì</i>
      <span class="step-number">1</span>
    </div>
    <small>Carrier Info</small>
  </div>
  <div class="stepper-item completed" data-step="2">
    <div class="step-counter">
      <i class="check-icon">‚úì</i>
      <span class="step-number">2</span>
    </div>
    <small>Conditions</small>
  </div>
  <div class="stepper-item active" data-step="3">
    <div class="step-counter">
      <span class="step-number">3</span>
    </div>
    <small>Sign Agreement</small>
  </div>
  <div class="stepper-item" data-step="4">
    <div class="step-counter">
      <span class="step-number">4</span>
    </div>
    <small>Preview</small>
  </div>
  <div class="stepper-item" data-step="5">
    <div class="step-counter">
      <span class="step-number">5</span>
    </div>
    <small>Done</small>
  </div>
</div>

<!-- Main Agreement Card -->
<div class="agreement-card">
  <div class="card-header-animated">
    <div class="icon-circle">‚úçÔ∏è</div>
    <h3 class="text-center mb-2 fw-bold">Sign Agreement</h3>
    <p class="text-center text-muted mb-4">Provide signatory details and choose deposit method.</p>
  </div>

  <form method="post" id="signatureForm" novalidate>
    {% csrf_token %}
    
    <!-- Signatory Information Section -->
    <div class="form-section">
      <h5 class="section-title">
        <span class="title-icon">üë§</span>
        Signatory Information
      </h5>
      
      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="form-group-animated">
            <label for="{{ form.signer_full_name.id_for_label }}" class="form-label">
              {{ form.signer_full_name.label }}
              <span class="required-star">*</span>
            </label>
            <div class="input-wrapper">
              <span class="input-icon">üë§</span>
              {{ form.signer_full_name }}
            </div>
            {% if form.signer_full_name.errors %}
              <div class="error-message">
                <i class="error-icon">‚ö†Ô∏è</i>
                {{ form.signer_full_name.errors.as_text|cut:"* " }}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="form-group-animated">
            <label for="{{ form.signer_title.id_for_label }}" class="form-label">
              {{ form.signer_title.label }}
              <span class="required-star">*</span>
            </label>
            <div class="input-wrapper">
              <span class="input-icon">üíº</span>
              {{ form.signer_title }}
            </div>
            {% if form.signer_title.errors %}
              <div class="error-message">
                <i class="error-icon">‚ö†Ô∏è</i>
                {{ form.signer_title.errors.as_text|cut:"* " }}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="form-group-animated">
            <label for="{{ form.signer_email.id_for_label }}" class="form-label">
              {{ form.signer_email.label }}
              <span class="required-star">*</span>
            </label>
            <div class="input-wrapper">
              <span class="input-icon">üìß</span>
              {{ form.signer_email }}
            </div>
            {% if form.signer_email.errors %}
              <div class="error-message">
                <i class="error-icon">‚ö†Ô∏è</i>
                {{ form.signer_email.errors.as_text|cut:"* " }}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Signature Section -->
        <div class="col-md-6 mb-4">
          <div class="form-group-animated">
            <label for="{{ form.signature_text.id_for_label }}" class="form-label">
              {{ form.signature_text.label }}
              <span class="required-star">*</span>
            </label>
            <div class="signature-input-container">
              <div class="input-wrapper">
                <span class="input-icon">‚úçÔ∏è</span>
                {{ form.signature_text }}
              </div>
              <div class="signature-font-selector">
                <button type="button" class="font-option active" data-font="Great Vibes">Aa</button>
                <button type="button" class="font-option" data-font="Dancing Script">Aa</button>
                <button type="button" class="font-option" data-font="Parisienne">Aa</button>
              </div>
            </div>
            {% if form.signature_text.errors %}
              <div class="error-message">
                <i class="error-icon">‚ö†Ô∏è</i>
                {{ form.signature_text.errors.as_text|cut:"* " }}
              </div>
            {% endif %}
            <small class="form-hint">
              <i>üí° Type your name to generate a digital signature</i>
            </small>
          </div>
        </div>
      </div>

      <!-- Signature Preview -->
      <div class="signature-preview-container" id="signaturePreview">
        <div class="preview-label">Signature Preview:</div>
        <div class="signature-preview" id="signatureCanvas">
          <span class="preview-placeholder">Your signature will appear here</span>
          <span class="preview-text" id="previewText"></span>
        </div>
        <div class="signature-line"></div>
        <small class="signature-date" id="signatureDate"></small>
      </div>
    </div>

    <input type="hidden" name="signature_image" id="signature_image">

    <!-- Divider -->
    <div class="section-divider">
      <span class="divider-text">Payment Information</span>
    </div>

    <!-- Deposit Method Section -->
    <div class="form-section">
      <h5 class="section-title">
        <span class="title-icon">üí≥</span>
        Deposit Method
      </h5>
      
      <div class="row">
        {% for choice in form.deposit_method.field.choices %}
        <div class="col-md-4 mb-3">
          <label class="deposit-option-card" data-method="{{ choice.0 }}">
            <input type="radio" 
                   name="{{ form.deposit_method.name }}" 
                   value="{{ choice.0 }}" 
                   {% if form.deposit_method.value == choice.0 %}checked{% endif %}>
            <div class="deposit-card">
              <div class="deposit-icon">
                {% if choice.0 == 'quick_pay' %}
                  ‚ö°
                {% elif choice.0 == 'standard' %}
                  üè¶
                {% elif choice.0 == 'factoring' %}
                  üìä
                {% else %}
                  üí∞
                {% endif %}
              </div>
              <div class="deposit-title">{{ choice.1 }}</div>
              <div class="deposit-check">
                <span class="checkmark-circle">‚úì</span>
              </div>
              <div class="deposit-details">
                {% if choice.0 == 'quick_pay' %}
                  <small>2% fee ‚Ä¢ Same day</small>
                {% elif choice.0 == 'standard' %}
                  <small>No fees ‚Ä¢ 24 hours</small>
                {% else %}
                  <small>Via third party</small>
                {% endif %}
              </div>
            </div>
          </label>
        </div>
        {% endfor %}
      </div>
      
      {% if form.deposit_method.errors %}
        <div class="error-message">
          <i class="error-icon">‚ö†Ô∏è</i>
          {{ form.deposit_method.errors.as_text|cut:"* " }}
        </div>
      {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <a href="{% url 'agreements:conditions' %}" class="btn btn-outline-secondary btn-animated">
        <span class="btn-icon-left">‚Üê</span>
        <span>Back</span>
      </a>
      <button type="submit" class="btn btn-primary btn-animated" id="submitBtn">
        <span class="btn-text">Continue</span>
        <span class="btn-icon-right">‚Üí</span>
        <span class="btn-loader"></span>
      </button>
    </div>
  </form>
</div>

<style>
/* ===== CSS Variables ===== */
:root {
  --primary-color: #114476;
  --primary-dark: #0d3763;
  --primary-light: #165b99;
  --secondary-color: #6c757d;
  --success-color: #28a745;
  --danger-color: #dc3545;
  --warning-color: #ffc107;
  --text-dark: #2c3e50;
  --text-muted: #6c757d;
  --border-color: #dee2e6;
  --bg-light: #f8f9fa;
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
  --shadow-xl: 0 20px 40px rgba(0,0,0,0.2);
  --transition-fast: 0.2s ease;
  --transition-normal: 0.3s ease;
  --transition-slow: 0.5s ease;
  --border-radius: 12px;
  --border-radius-lg: 16px;
}

/* ===== Global Animations ===== */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.05);
    opacity: 0.9;
  }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
  20%, 40%, 60%, 80% { transform: translateX(8px); }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
  60% {
    transform: translateY(-5px);
  }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes shimmer {
  0% {
    background-position: -1000px 0;
  }
  100% {
    background-position: 1000px 0;
  }
}

@keyframes checkmark {
  0% {
    transform: scale(0) rotate(45deg);
  }
  50% {
    transform: scale(1.2) rotate(45deg);
  }
  100% {
    transform: scale(1) rotate(45deg);
  }
}

@keyframes draw {
  from {
    stroke-dashoffset: 1000;
  }
  to {
    stroke-dashoffset: 0;
  }
}

@keyframes glow {
  0%, 100% {
    box-shadow: 0 0 5px rgba(17, 68, 118, 0.5);
  }
  50% {
    box-shadow: 0 0 20px rgba(17, 68, 118, 0.8);
  }
}

/* ===== Stepper Styles ===== */
.stepper-wrapper {
  display: flex;
  justify-content: space-between;
  margin: 2rem auto 3rem;
  max-width: 900px;
  position: relative;
  animation: fadeInDown 0.6s ease;
  padding: 0 1rem;
}

.stepper-item {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
  animation: fadeIn 0.5s ease backwards;
}

.stepper-item:nth-child(1) { animation-delay: 0.1s; }
.stepper-item:nth-child(2) { animation-delay: 0.2s; }
.stepper-item:nth-child(3) { animation-delay: 0.3s; }
.stepper-item:nth-child(4) { animation-delay: 0.4s; }
.stepper-item:nth-child(5) { animation-delay: 0.5s; }

.stepper-item::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 3px;
  background: var(--border-color);
  top: 22px;
  left: -50%;
  z-index: -1;
  transition: all var(--transition-slow);
}

.stepper-item:first-child::before {
  content: none;
}

.stepper-item.completed::before,
.stepper-item.active::before {
  background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
}

.step-counter {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: white;
  border: 3px solid var(--border-color);
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 8px;
  font-weight: bold;
  color: var(--text-muted);
  transition: all var(--transition-normal);
  position: relative;
  box-shadow: var(--shadow-sm);
  z-index: 1;
}

.stepper-item.active .step-counter {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  border-color: var(--primary-color);
  color: white;
  transform: scale(1.15);
  box-shadow: 0 0 20px rgba(17, 68, 118, 0.5);
  animation: pulse 2s infinite;
}

.stepper-item.completed .step-counter {

  color: white;
  animation: scaleIn 0.5s ease;
}

.step-counter .check-icon {
  display: none;
  font-style: normal;
  animation: checkmark 0.5s ease;
}

.stepper-item.completed .check-icon {
  display: block;
}

.stepper-item.completed .step-number {
  display: none;
}

.stepper-item small {
  text-align: center;
  color: var(--text-muted);
  font-size: 0.75rem;
  font-weight: 500;
  transition: all var(--transition-normal);
}

.stepper-item.active small {
  color: var(--primary-color);
  font-weight: 600;
  transform: scale(1.05);
}



/* ===== Agreement Card ===== */
.agreement-card {
  max-width: 1000px;
  margin: 0 auto;
  background: white;
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-lg);
  padding: 2.5rem;
  animation: fadeInUp 0.8s ease;
  transition: all var(--transition-normal);
}

.agreement-card:hover {
  box-shadow: var(--shadow-xl);
}

/* ===== Card Header ===== */
.card-header-animated {
  text-align: center;
  margin-bottom: 2.5rem;
  animation: fadeInDown 0.6s ease 0.3s backwards;
}

.icon-circle {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  margin-bottom: 1rem;
  animation: scaleIn 0.6s ease 0.4s backwards, pulse 3s infinite;
  box-shadow: var(--shadow-md);
}

.card-header-animated h3 {
  color: var(--text-dark);
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.card-header-animated p {
  font-size: 1.1rem;
}

/* ===== Form Sections ===== */
.form-section {
  margin-bottom: 2.5rem;
  animation: fadeInUp 0.6s ease backwards;
}

.form-section:nth-child(1) { animation-delay: 0.5s; }
.form-section:nth-child(2) { animation-delay: 0.6s; }

.section-title {
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text-dark);
  font-size: 1.3rem;
  margin-bottom: 1.5rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid var(--border-color);
}

.title-icon {
  font-size: 1.5rem;
  animation: bounce 2s infinite;
}

/* ===== Form Groups ===== */
.form-group-animated {
  animation: slideInLeft 0.5s ease backwards;
}

.col-md-6:nth-child(odd) .form-group-animated {
  animation: slideInLeft 0.5s ease backwards;
}

.col-md-6:nth-child(even) .form-group-animated {
  animation: slideInRight 0.5s ease backwards;
}

.form-label {
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
  display: block;
  font-size: 0.95rem;
}

.required-star {
  color: var(--danger-color);
  margin-left: 3px;
}

.input-wrapper {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.2rem;
  z-index: 2;
  pointer-events: none;
  transition: all var(--transition-normal);
}

.input-wrapper input,
.input-wrapper select,
.input-wrapper textarea {
  width: 100%;
  padding: 12px 15px 12px 45px;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: 1rem;
  transition: all var(--transition-normal);
  background: white;
}

.input-wrapper input:focus,
.input-wrapper select:focus,
.input-wrapper textarea:focus {
  border-color: var(--primary-color);
  outline: none;
  box-shadow: 0 0 0 4px rgba(17, 68, 118, 0.1);
  transform: translateY(-2px);
}

.input-wrapper input:focus + .input-icon,
.input-wrapper:focus-within .input-icon {
  transform: translateY(-50%) scale(1.2);
  filter: brightness(1.2);
}

/* ===== Signature Styles ===== */
.signature-input-container {
  position: relative;
}

input[name="signature_text"] {
  font-family: 'Great Vibes', cursive;
  font-size: 32px !important;
  color: var(--primary-color);
  padding: 15px 15px 15px 50px !important;
  background: linear-gradient(to right, #fafafa, white) !important;
  transition: all var(--transition-normal);
}

input[name="signature_text"]:focus {
  background: white !important;
  animation: glow 2s infinite;
}

.signature-font-selector {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.font-option {
  flex: 1;
  padding: 8px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  background: white;
  cursor: pointer;
  font-size: 1.2rem;
  transition: all var(--transition-normal);
  font-weight: bold;
}

.font-option:nth-child(1) { font-family: 'Great Vibes', cursive; }
.font-option:nth-child(2) { font-family: 'Dancing Script', cursive; }
.font-option:nth-child(3) { font-family: 'Parisienne', cursive; }

.font-option:hover {
  border-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.font-option.active {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  color: white;
  box-shadow: var(--shadow-md);
}

/* ===== Signature Preview ===== */
.signature-preview-container {
  margin-top: 2rem;
  padding: 2rem;
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border-radius: var(--border-radius);
  border: 2px dashed var(--border-color);
  animation: fadeInUp 0.6s ease 0.7s backwards;
  transition: all var(--transition-normal);
}

.signature-preview-container:hover {
  border-color: var(--primary-light);
  box-shadow: var(--shadow-md);
}

.preview-label {
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 1rem;
  font-size: 0.9rem;
}

.signature-preview {
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  margin-bottom: 1rem;
}

.preview-placeholder {
  color: var(--text-muted);
  font-style: italic;
  opacity: 0.6;
  transition: all var(--transition-normal);
}

.preview-text {
  font-family: 'Great Vibes', cursive;
  font-size: 48px;
  color: var(--primary-color);
  display: none;
  animation: fadeIn 0.5s ease;
}

.preview-text.show {
  display: block;
}

.preview-placeholder.hide {
  display: none;
}

.signature-line {
  height: 2px;
  background: linear-gradient(to right, transparent, var(--primary-color), transparent);
  margin: 1rem 0;
  animation: shimmer 3s infinite;
  background-size: 200% 100%;
}

.signature-date {
  display: block;
  text-align: center;
  color: var(--text-muted);
  font-style: italic;
}

.form-hint {
  display: block;
  margin-top: 0.5rem;
  color: var(--text-muted);
  font-size: 0.85rem;
}

/* ===== Error Messages ===== */
.error-message {
  color: var(--danger-color);
  font-size: 0.875rem;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  gap: 5px;
  animation: shake 0.5s ease, fadeIn 0.3s ease;
}

.error-icon {
  font-style: normal;
}

/* ===== Section Divider ===== */
.section-divider {
  position: relative;
  text-align: center;
  margin: 3rem 0;
  animation: fadeIn 0.6s ease 0.8s backwards;
}

.section-divider::before {
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  top: 50%;
  height: 2px;
  background: linear-gradient(to right, transparent, var(--border-color), transparent);
}

.divider-text {
  position: relative;
  background: white;
  padding: 0 20px;
  color: var(--text-muted);
  font-weight: 600;
  font-size: 1rem;
}

/* ===== Deposit Method Cards ===== */
.deposit-option-card {
  display: block;
  cursor: pointer;
  text-decoration: none;
  animation: scaleIn 0.5s ease backwards;
}

.deposit-option-card:nth-child(1) { animation-delay: 0.9s; }
.deposit-option-card:nth-child(2) { animation-delay: 1.0s; }
.deposit-option-card:nth-child(3) { animation-delay: 1.1s; }

.deposit-option-card input[type="radio"] {
  display: none;
}

.deposit-card {
  position: relative;
  padding: 2rem 1.5rem;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  background: white;
  text-align: center;
  transition: all var(--transition-normal);
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1rem;
}

.deposit-card:hover {
  border-color: var(--primary-light);
  transform: translateY(-5px);
  box-shadow: var(--shadow-md);
}

.deposit-option-card input[type="radio"]:checked + .deposit-card {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, rgba(17, 68, 118, 0.05), rgba(22, 91, 153, 0.05));
  box-shadow: 0 0 20px rgba(17, 68, 118, 0.3);
  transform: translateY(-5px) scale(1.03);
}

.deposit-icon {
  font-size: 3rem;
  margin-bottom: 0.5rem;
  transition: all var(--transition-normal);
}

.deposit-option-card:hover .deposit-icon {
  transform: scale(1.2) rotate(5deg);
  animation: bounce 1s ease;
}

.deposit-title {
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.deposit-check {
  position: absolute;
  top: 15px;
  right: 15px;
  opacity: 0;
  transition: all var(--transition-normal);
}

.checkmark-circle {
  width: 30px;
  height: 30px;
  background: var(--success-color);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  box-shadow: var(--shadow-sm);
}

.deposit-option-card input[type="radio"]:checked + .deposit-card .deposit-check {
  opacity: 1;
  animation: scaleIn 0.4s ease;
}

.deposit-details {
  color: var(--text-muted);
  font-size: 0.85rem;
}

/* ===== Action Buttons ===== */
.action-buttons {
  display: flex;
  gap: 1rem;
  justify-content: space-between;
  margin-top: 2.5rem;
  animation: fadeInUp 0.6s ease 1.2s backwards;
}

.btn-animated {
  padding: 14px 32px;
  font-weight: 600;
  border-radius: var(--border-radius);
  transition: all var(--transition-normal);
  position: relative;
  overflow: hidden;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-size: 1rem;
  border: none;
}

.btn-animated::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn-animated:hover::before {
  width: 400px;
  height: 400px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  color: white;
  box-shadow: var(--shadow-md);
  position: relative;
}

.btn-primary:hover {
  background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(17, 68, 118, 0.4);
}

.btn-primary:active {
  transform: translateY(-1px);
}

.btn-outline-secondary {
  border: 2px solid var(--secondary-color);
  color: var(--secondary-color);
  background: white;
}

.btn-outline-secondary:hover {
  background: var(--secondary-color);
  color: white;
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
}

.btn-icon-left,
.btn-icon-right {
  transition: transform var(--transition-normal);
  position: relative;
  z-index: 1;
}

.btn-primary:hover .btn-icon-right {
  transform: translateX(5px);
}

.btn-outline-secondary:hover .btn-icon-left {
  transform: translateX(-5px);
}

.btn-loader {
  display: none;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  position: relative;
  z-index: 1;
}

.btn-animated.loading .btn-text,
.btn-animated.loading .btn-icon-right {
  display: none;
}

.btn-animated.loading .btn-loader {
  display: block;
}

.btn-animated.loading {
  pointer-events: none;
  opacity: 0.8;
}

/* ===== Responsive Design ===== */
@media (max-width: 992px) {
  .agreement-card {
    padding: 2rem;
  }

  .icon-circle {
    width: 70px;
    height: 70px;
    font-size: 2rem;
  }

  .card-header-animated h3 {
    font-size: 1.75rem;
  }
}

@media (max-width: 768px) {
  .stepper-wrapper {
    margin: 1.5rem auto 2rem;
    padding: 0 0.5rem;
  }

  .stepper-item small {
    font-size: 0.65rem;
    max-width: 60px;
  }

  .step-counter {
    width: 40px;
    height: 40px;
    font-size: 0.9rem;
  }

  .stepper-item::before {
    top: 19px;
  }

  .agreement-card {
    padding: 1.5rem;
    border-radius: var(--border-radius);
    margin: 0 0.5rem;
  }

  .icon-circle {
    width: 60px;
    height: 60px;
    font-size: 1.75rem;
  }

  .card-header-animated h3 {
    font-size: 1.5rem;
  }

  .card-header-animated p {
    font-size: 1rem;
  }

  .section-title {
    font-size: 1.1rem;
  }

  input[name="signature_text"] {
    font-size: 24px !important;
  }

  .preview-text {
    font-size: 36px;
  }

  .signature-preview-container {
    padding: 1.5rem;
  }

  .action-buttons {
    flex-direction: column;
  }

  .btn-animated {
    width: 100%;
    justify-content: center;
  }

  .deposit-card {
    padding: 1.5rem 1rem;
  }

  .deposit-icon {
    font-size: 2.5rem;
  }
}

@media (max-width: 576px) {
  .stepper-wrapper {
    overflow-x: auto;
    padding-bottom: 1rem;
  }

  .stepper-item {
    min-width: 70px;
  }

  .agreement-card {
    padding: 1rem;
  }

  .form-section {
    margin-bottom: 2rem;
  }

  .signature-font-selector {
    flex-direction: column;
  }

  .font-option {
    width: 100%;
  }

  input[name="signature_text"] {
    font-size: 20px !important;
  }

  .preview-text {
    font-size: 28px;
  }
}

@media (min-width: 1200px) {
  .agreement-card {
    padding: 3rem 3.5rem;
  }
}

/* ===== Print Styles ===== */
@media print {
  .stepper-wrapper,
  .action-buttons,
  .signature-font-selector {
    display: none;
  }

  .agreement-card {
    box-shadow: none;
    padding: 0;
  }
}

/* ===== Accessibility ===== */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Focus visible for keyboard navigation */
.btn-animated:focus-visible,
.deposit-option-card:focus-within .deposit-card,
input:focus-visible,
select:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 3px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ===== Signature Input and Preview =====
  const signatureInput = document.querySelector('input[name="signature_text"]');
  const previewText = document.getElementById('previewText');
  const previewPlaceholder = document.querySelector('.preview-placeholder');
  const signatureDate = document.getElementById('signatureDate');
  const fontOptions = document.querySelectorAll('.font-option');
  
  // Set current date
  const today = new Date().toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  signatureDate.textContent = `Signed on ${today}`;
  
  // Update signature preview
  if (signatureInput && previewText) {
    signatureInput.addEventListener('input', function() {
      const value = this.value.trim();
      
      if (value) {
        previewText.textContent = value;
        previewText.classList.add('show');
        previewPlaceholder.classList.add('hide');
        
        // Add animation
        previewText.style.animation = 'none';
        setTimeout(() => {
          previewText.style.animation = 'fadeIn 0.5s ease';
        }, 10);
      } else {
        previewText.classList.remove('show');
        previewPlaceholder.classList.remove('hide');
      }
    });
    
    // Trigger on page load if value exists
    if (signatureInput.value.trim()) {
      signatureInput.dispatchEvent(new Event('input'));
    }
  }
  
  // ===== Signature Font Selector =====
  fontOptions.forEach(option => {
    option.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Remove active from all
      fontOptions.forEach(opt => opt.classList.remove('active'));
      
      // Add active to clicked
      this.classList.add('active');
      
      // Update font
      const fontFamily = this.getAttribute('data-font');
      signatureInput.style.fontFamily = `'${fontFamily}', cursive`;
      previewText.style.fontFamily = `'${fontFamily}', cursive`;
      
      // Animation effect
      this.style.animation = 'none';
      setTimeout(() => {
        this.style.animation = 'pulse 0.4s ease';
      }, 10);
    });
  });
  
  // ===== Deposit Method Cards Animation =====
  const depositCards = document.querySelectorAll('.deposit-option-card');
  
  depositCards.forEach(card => {
    const radio = card.querySelector('input[type="radio"]');
    
    card.addEventListener('click', function() {
      // Animate all cards
      depositCards.forEach(c => {
        c.querySelector('.deposit-card').style.animation = 'none';
        setTimeout(() => {
          c.querySelector('.deposit-card').style.animation = '';
        }, 10);
      });
      
      // Check radio
      radio.checked = true;
      
      // Animation for selected card
      setTimeout(() => {
        this.querySelector('.deposit-card').style.animation = 'pulse 0.5s ease';
      }, 50);
    });
  });
  
  // ===== Form Validation =====
  const form = document.getElementById('signatureForm');
  const submitBtn = document.getElementById('submitBtn');
  
  if (form && submitBtn) {
    form.addEventListener('submit', function(e) {
      let hasErrors = false;
      
      // Clear previous errors
      document.querySelectorAll('.error-message').forEach(err => {
        if (!err.hasAttribute('data-server-error')) {
          err.remove();
        }
      });
      
      // Validate required fields
      const requiredFields = form.querySelectorAll('[required]');
      
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          hasErrors = true;
          
          // Add error message
          const wrapper = field.closest('.form-group-animated') || field.closest('.col-md-6');
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.innerHTML = '<i class="error-icon">‚ö†Ô∏è</i> This field is required';
          
          if (wrapper) {
            wrapper.appendChild(errorDiv);
            
            // Shake animation
            wrapper.style.animation = 'shake 0.5s ease';
            setTimeout(() => {
              wrapper.style.animation = '';
            }, 500);
          }
          
          // Focus first error
          if (!field.matches('[type="radio"]')) {
            field.focus();
          }
        }
      });
      
      // Validate deposit method
      const depositMethodChecked = form.querySelector('input[name="deposit_method"]:checked');
      if (!depositMethodChecked) {
        hasErrors = true;
        
        const depositSection = document.querySelector('.deposit-option-card').closest('.row');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = '<i class="error-icon">‚ö†Ô∏è</i> Please select a deposit method';
        depositSection.parentNode.appendChild(errorDiv);
      }
      
      if (hasErrors) {
        e.preventDefault();
        
        // Scroll to first error
        const firstError = document.querySelector('.error-message');
        if (firstError) {
          firstError.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
        }
        
        return false;
      }
      
      // Show loading state
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;
    });
  }
  
  // ===== Input Field Animations =====
  const inputs = form.querySelectorAll('input, select, textarea');
  
  inputs.forEach(input => {
    // Focus animation
    input.addEventListener('focus', function() {
      const wrapper = this.closest('.input-wrapper');
      if (wrapper) {
        wrapper.style.animation = 'none';
        setTimeout(() => {
          wrapper.style.animation = 'pulse 0.3s ease';
        }, 10);
      }
    });
    
    // Validation on blur
    input.addEventListener('blur', function() {
      if (this.hasAttribute('required') && !this.value.trim()) {
        this.style.borderColor = 'var(--danger-color)';
        
        setTimeout(() => {
          this.style.borderColor = '';
        }, 2000);
      }
    });
  });
  
  // ===== Smooth Scroll for Form Sections =====
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -100px 0px'
  };
  
  const sectionObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, observerOptions);
  
  document.querySelectorAll('.form-section').forEach(section => {
    sectionObserver.observe(section);
  });
  
  // ===== Auto-save to localStorage (optional) =====
  const autoSaveFields = ['signer_full_name', 'signer_title', 'signer_email'];
  
  autoSaveFields.forEach(fieldName => {
    const field = form.querySelector(`[name="${fieldName}"]`);
    if (field) {
      // Load saved value
      const saved = localStorage.getItem(`agreement_${fieldName}`);
      if (saved && !field.value) {
        field.value = saved;
      }
      
      // Save on change
      field.addEventListener('change', function() {
        localStorage.setItem(`agreement_${fieldName}`, this.value);
      });
    }
  });
  
  // Clear localStorage on successful submission
  form.addEventListener('submit', function() {
    if (!this.querySelector('.error-message')) {
      autoSaveFields.forEach(fieldName => {
        localStorage.removeItem(`agreement_${fieldName}`);
      });
    }
  });
  
  // ===== Add tooltips on hover (optional enhancement) =====
  const depositOptions = document.querySelectorAll('.deposit-card');
  
  depositOptions.forEach(option => {
    option.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-5px) scale(1.02)';
    });
    
    option.addEventListener('mouseleave', function() {
      if (!this.previousElementSibling?.checked) {
        this.style.transform = '';
      }
    });
  });
});

// ===== Save signature as image (canvas conversion) =====
function saveSignature() {
  const signatureText = document.querySelector('input[name="signature_text"]').value;
  const signatureImageInput = document.getElementById('signature_image');
  
  if (signatureText) {
    // Create canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 600;
    canvas.height = 200;
    
    // Set background
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Set text style
    const font = document.querySelector('.font-option.active').getAttribute('data-font');
    ctx.font = `48px '${font}', cursive`;
    ctx.fillStyle = '#114476';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // Draw text
    ctx.fillText(signatureText, canvas.width / 2, canvas.height / 2);
    
    // Convert to base64
    const imageData = canvas.toDataURL('image/png');
    signatureImageInput.value = imageData;
  }
  
  return true;
}
</script>

{% endblock %}